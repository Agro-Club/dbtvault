SELECT 
                CAST(CUSTOMER_PK AS BINARY(16)) AS CUSTOMER_PK,
                CAST(CUSTOMERKEY AS NUMBER(38,0)) AS CUSTOMERKEY,
                CAST(SOURCE AS VARCHAR(4)) AS SOURCE,
                CAST(LOADDATE AS DATE) AS LOADDATE
 FROM (
  SELECT DISTINCT CUSTOMER_PK, CUSTOMERKEY, SOURCE, LOADDATE, FIRST_SOURCE
  FROM
    (SELECT DISTINCT a.CUSTOMER_PK, a.CUSTOMERKEY, a.SOURCE, a.LOADDATE,
           lag(a.SOURCE, 1)
           over(partition by a.CUSTOMER_PK
           order by a.CUSTOMER_PK) as FIRST_SOURCE
    FROM DV_PROTOTYPE_DB.SRC_STG.stg_orders_hashed AS a
    LEFT JOIN DV_PROTOTYPE_DB.SRC_VLT.hub_customer AS c
    ON a.CUSTOMER_PK = c.CUSTOMER_PK
    AND c.CUSTOMER_PK IS NULL
    )
 AS b)
AS stg
WHERE stg.CUSTOMER_PK NOT IN (SELECT CUSTOMER_PK FROM DV_PROTOTYPE_DB.SRC_VLT.hub_customer)
AND FIRST_SOURCE IS NULL