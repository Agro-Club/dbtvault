name: "dbtvault_test"
version: "0.6"
require-dbt-version: [">=0.14.0", "<0.17.0"]

profile: "dbtvault"

source-paths: ["models"]
analysis-paths: ["analysis"]
test-paths: ["tests"]
data-paths: ["data"]
macro-paths: ["macros"]

target-path: "target"
clean-targets:
    - "target"
    - "dbt_modules"

models:
  dbtvault_test:
    unit:
      staging:
        hash_columns:
          vars:
            columns:
              BOOKING_PK: BOOKING_REF
              CUSTOMER_PK: CUSTOMER_ID
              CUSTOMER_BOOKING_PK:
                - CUSTOMER_ID
                - BOOKING_REF
              BOOK_CUSTOMER_HASHDIFF:
                hashdiff: true
                columns:
                  - PHONE
                  - NATIONALITY
                  - CUSTOMER_ID
              BOOK_BOOKING_HASHDIFF:
                hashdiff: true
                columns:
                  - BOOKING_REF
                  - BOOKING_DATE
                  - DEPARTURE_DATE
                  - PRICE
                  - DESTINATION
          test_hash_columns_correctly_generates_sql_with_constants_from_yaml:
            vars:
              columns:
                BOOKING_PK: BOOKING_REF
                CUSTOMER_PK: 
                  - CUSTOMER_ID
                  - "!9999-12-31"
                CUSTOMER_BOOKING_PK:
                  - CUSTOMER_ID
                  - BOOKING_REF
                  - "TO_DATE('9999-12-31')"
                BOOK_CUSTOMER_HASHDIFF:
                  hashdiff: true
                  columns:
                    - PHONE
                    - NATIONALITY
                    - CUSTOMER_ID
                BOOK_BOOKING_HASHDIFF:
                  hashdiff: true
                  columns:
                    - BOOKING_REF
                    - "TO_DATE('9999-12-31')"
                    - "!STG"
                    - BOOKING_DATE
                    - DEPARTURE_DATE
                    - PRICE
                    - DESTINATION
          test_hash_columns_raises_warning_if_mapping_without_hashdiff:
            vars:
              columns:
                BOOKING_PK: BOOKING_REF
                CUSTOMER_PK: CUSTOMER_ID
                CUSTOMER_BOOKING_PK:
                  - CUSTOMER_ID
                  - BOOKING_REF
                BOOK_CUSTOMER_HASHDIFF:
                  columns:
                    - PHONE
                    - NATIONALITY
                    - CUSTOMER_ID
                BOOK_BOOKING_HASHDIFF:
                  columns:
                    - BOOKING_REF
                    - BOOKING_DATE
                    - DEPARTURE_DATE
                    - PRICE
                    - DESTINATION
        stage:
          test_stage_correctly_generates_sql_from_yaml:
            vars:
              include_source_columns: true
              source_model: "raw_source"
              hashed_columns:
                CUSTOMER_PK: CUSTOMER_ID
                CUST_CUSTOMER_HASHDIFF:
                  hashdiff: true
                  columns:
                  - CUSTOMER_DOB
                  - CUSTOMER_ID
                  - CUSTOMER_NAME
                CUSTOMER_HASHDIFF:
                  hashdiff: true
                  columns:
                    - CUSTOMER_ID
                    - NATIONALITY
                    - PHONE
              derived_columns:
                columns:
                  SOURCE: "!STG_BOOKING"
                  EFFECTIVE_FROM: "BOOKING_DATE"
          test_stage_correctly_generates_sql_from_yaml_with_source_style:
            vars:
              include_source_columns: true
              source_model:
                test_unit: "source"
              hashed_columns:
                CUSTOMER_PK: CUSTOMER_ID
                CUST_CUSTOMER_HASHDIFF:
                  hashdiff: true
                  columns:
                    - CUSTOMER_DOB
                    - CUSTOMER_ID
                    - CUSTOMER_NAME
                CUSTOMER_HASHDIFF:
                  hashdiff: true
                  columns:
                    - CUSTOMER_ID
                    - NATIONALITY
                    - PHONE
              derived_columns:
                columns:
                  SOURCE: "!STG_BOOKING"
                  EFFECTIVE_FROM: "LOADDATE"
          test_stage_correctly_generates_sql_for_only_source_columns_from_yaml:
            vars:
              include_source_columns: true
              source_model: "raw_source"
          test_stage_correctly_generates_sql_for_only_hashing_from_yaml:
            vars:
              include_source_columns: false
              source_model: "raw_source"
              hashed_columns:
                CUSTOMER_PK: CUSTOMER_ID
                CUST_CUSTOMER_HASHDIFF:
                  hashdiff: true
                  columns:
                    - CUSTOMER_DOB
                    - CUSTOMER_ID
                    - CUSTOMER_NAME
                CUSTOMER_HASHDIFF:
                  hashdiff: true
                  columns:
                    - CUSTOMER_ID
                    - NATIONALITY
                    - PHONE
          test_stage_correctly_generates_sql_for_hashing_and_source_from_yaml:
            vars:
              include_source_columns: true
              source_model: "raw_source"
              hashed_columns:
                CUSTOMER_PK: CUSTOMER_ID
                CUST_CUSTOMER_HASHDIFF:
                  hashdiff: true
                  columns:
                    - CUSTOMER_DOB
                    - CUSTOMER_ID
                    - CUSTOMER_NAME
                CUSTOMER_HASHDIFF:
                  hashdiff: true
                  columns:
                    - CUSTOMER_ID
                    - NATIONALITY
                    - PHONE
          test_stage_raises_error_with_missing_source:
            vars:
              include_source_columns: true
              hashed_columns:
                CUSTOMER_PK: CUSTOMER_ID
                CUST_CUSTOMER_HASHDIFF:
                  hashdiff: true
                  columns:
                    - CUSTOMER_DOB
                    - CUSTOMER_ID
                    - CUSTOMER_NAME
                CUSTOMER_HASHDIFF:
                  hashdiff: true
                  columns:
                    - CUSTOMER_ID
                    - NATIONALITY
                    - PHONE
              derived_columns:
                columns:
                  SOURCE: "!STG_BOOKING"
                  EFFECTIVE_FROM: "LOADDATE"
      tables:
        hub:
          materialized: "incremental"
          test_hub_macro_correctly_generates_sql_for_single_source:
            vars:
              source_model: "raw_source"
              src_pk: "CUSTOMER_PK"
              src_nk: "CUSTOMER_ID"
              src_ldts: "LOADDATE"
              src_source: "RECORD_SOURCE"
          test_hub_macro_correctly_generates_sql_for_incremental_single_source:
            vars:
              source_model: "raw_source"
              src_pk: "CUSTOMER_PK"
              src_nk: "CUSTOMER_ID"
              src_ldts: "LOADDATE"
              src_source: "RECORD_SOURCE"
          test_hub_macro_correctly_generates_sql_for_multi_source:
            vars:
              source_model:
                - "raw_source"
                - "raw_source_2"
              src_pk: "CUSTOMER_PK"
              src_nk: "CUSTOMER_ID"
              src_ldts: "LOADDATE"
              src_source: "RECORD_SOURCE"
          test_hub_macro_correctly_generates_sql_for_incremental_multi_source:
            vars:
              source_model:
                - "raw_source"
                - "raw_source_2"
              src_pk: "CUSTOMER_PK"
              src_nk: "CUSTOMER_ID"
              src_ldts: "LOADDATE"
              src_source: "RECORD_SOURCE"
        link:
          materialized: "incremental"
          test_link_macro_correctly_generates_sql_for_single_source:
            vars:
              source_model: "raw_source"
              src_pk: "CUSTOMER_PK"
              src_fk: 
                - "ORDER_FK"
                - "BOOKING_FK"
              src_ldts: "LOADDATE"
              src_source: "RECORD_SOURCE"
          test_link_macro_correctly_generates_sql_for_incremental_single_source:
            vars:
              source_model: "raw_source"
              src_pk: "CUSTOMER_PK"
              src_fk: 
                - "ORDER_FK"
                - "BOOKING_FK"
              src_ldts: "LOADDATE"
              src_source: "RECORD_SOURCE"
          test_link_macro_correctly_generates_sql_for_multi_source:
            vars:
              source_model:
                - "raw_source"
                - "raw_source_2"
              src_pk: "CUSTOMER_PK"
              src_fk: 
                - "ORDER_FK"
                - "BOOKING_FK"
              src_ldts: "LOADDATE"
              src_source: "RECORD_SOURCE"
          test_link_macro_correctly_generates_sql_for_incremental_multi_source:
            vars:
              source_model:
                - "raw_source"
                - "raw_source_2"
              src_pk: "CUSTOMER_PK"
              src_fk: 
                - "ORDER_FK"
                - "BOOKING_FK"
              src_ldts: "LOADDATE"
              src_source: "RECORD_SOURCE"
    feature:
      tags:
        - feature
        - current
      current:
        load_cycles:
          tags:
            - load_cycles_current
          hashing:
            materialized: table
            schema: "stg"
            tags:
              - load_cycles_hashing
            test_stg_booking_hashed_current:
              vars:   
                include_source_columns: true
                source_model:
                  test_current: "stg_booking_current"
                hashed_columns:
                  BOOKING_PK: BOOKING_REF
                  CUSTOMER_PK: CUSTOMER_ID
                  CUSTOMER_BOOKING_PK: 
                    - CUSTOMER_ID
                    - BOOKING_REF
                  BOOK_CUSTOMER_HASHDIFF:
                    hashdiff: true
                    columns:
                      - CUSTOMER_ID
                      - NATIONALITY
                      - PHONE
                  BOOK_BOOKING_HASHDIFF:
                    hashdiff: true
                    columns:
                      - BOOKING_REF
                      - BOOKING_DATE
                      - DEPARTURE_DATE
                      - PRICE
                      - DESTINATION
                derived_columns:
                  columns:
                    EFFECTIVE_FROM: "BOOKING_DATE"
                    SOURCE: "!STG_BOOKING"
            test_stg_customer_hashed_current:
              vars:  
                include_source_columns: true
                source_model:
                  test_current: "stg_customer_current"
                hashed_columns:
                  CUSTOMER_PK: CUSTOMER_ID
                  CUST_CUSTOMER_HASHDIFF:
                    hashdiff: true
                    columns:
                      - CUSTOMER_ID
                      - CUSTOMER_NAME
                      - CUSTOMER_DOB
                  CUSTOMER_HASHDIFF:
                    hashdiff: true
                    columns:
                      - CUSTOMER_ID
                      - CUSTOMER_NAME
                      - CUSTOMER_DOB
                derived_columns:
                  columns:
                    EFFECTIVE_FROM: "LOADDATE"
                    SOURCE: "!STG_CUSTOMER"
          hubs:
            materialized: incremental
            schema: vlt
            tags:
              - load_cycles_hubs
            test_hub_booking_current:
              vars:
                source_model: "test_stg_booking_hashed_current"
                src_pk: "BOOKING_PK"
                src_nk: "BOOKING_REF"
                src_ldts: "LOADDATE"
                src_source: "SOURCE"
            test_hub_customer_current:
              vars:
                source_model:
                  - "test_stg_booking_hashed_current"
                  - "test_stg_customer_hashed_current"
                src_pk: "CUSTOMER_PK"
                src_nk: "CUSTOMER_ID"
                src_ldts: "LOADDATE"
                src_source: "SOURCE"
          links:
            materialized: incremental
            schema: vlt
            tags:
              - load_cycles_links
            test_link_customer_booking_current:
              vars:
                source_model: "test_stg_booking_hashed_current"
                src_pk: "CUSTOMER_BOOKING_PK"
                src_fk:
                  - "CUSTOMER_PK"
                  - "BOOKING_PK"
                src_ldts: "LOADDATE"
                src_source: "SOURCE"
          sats:
            materialized: incremental
            schema: vlt
            tags:
              - load_cycles_sats
            test_sat_book_booking_details_current:
              vars:
                source_model: "test_stg_booking_hashed_current"
                src_pk: "BOOKING_PK"
                src_hashdiff:
                  source_column: "BOOK_BOOKING_HASHDIFF"
                  alias: "HASHDIFF"
                src_payload:
                  - "PRICE"
                  - "BOOKING_DATE"
                  - "DEPARTURE_DATE"
                  - "DESTINATION"
                src_eff: "EFFECTIVE_FROM"
                src_ldts: "LOADDATE"
                src_source: "SOURCE"
            test_sat_book_customer_details_current:
              vars:
                source_model: "test_stg_booking_hashed_current"
                src_pk: "CUSTOMER_PK"
                src_hashdiff:
                  source_column: "BOOK_CUSTOMER_HASHDIFF"
                  alias: "HASHDIFF"
                src_payload:
                  - "PHONE"
                  - "NATIONALITY"
                src_eff: "EFFECTIVE_FROM"
                src_ldts: "LOADDATE"
                src_source: "SOURCE"
            test_sat_cust_customer_details_current:
              vars:
                source_model: "test_stg_customer_hashed_current"
                src_pk: "CUSTOMER_PK"
                src_hashdiff: 
                  source_column: "CUSTOMER_HASHDIFF"
                  alias: "HASHDIFF"
                src_payload:
                  - "CUSTOMER_DOB"
                  - "CUSTOMER_NAME"
                src_eff: "EFFECTIVE_FROM"
                src_ldts: "LOADDATE"
                src_source: "SOURCE"
        load_hubs:
          hashing: 
            materialized: table
            schema: "stg"
            tags:
              - load_hubs_hashing
            test_stg_customer_hashed_hubs_current:
              vars:
                include_source_columns: true
                source_model: 
                  test_current: "stg_customer_hubs_current"
                hashed_columns:
                  CUSTOMER_PK: CUSTOMER_ID
                derived_columns:
                  columns:
                    EFFECTIVE_FROM: "LOADDATE"
            test_stg_lineitem_hashed_current:
              vars:
                include_source_columns: true
                source_model:
                  test_current: "stg_lineitem_current"
                hashed_columns:
                  ORDER_PK: ORDER_ID
                  PART_PK: PART_ID
                  SUPPLIER_PK: SUPPLIER_ID
                  LINEITEM_PK: LINENUMBER
            test_stg_parts_hashed_current:
              vars:
                include_source_columns: true
                source_model:
                  test_current: "stg_parts_current"
                hashed_columns:
                  PART_PK: PART_ID
            test_stg_supplier_hashed_current:
              vars:
                include_source_columns: true
                source_model:
                  test_current: "stg_supplier_current"
                hashed_columns:
                  PART_PK: PART_ID   
                  SUPPLIER_PK: SUPPLIER_ID
          single:
            materialized: incremental
            schema: vlt
            tags:
              - single
              - hub
            test_hub_customer_hubs_current:
              vars:
                source_model: "test_stg_customer_hashed_hubs_current"
                src_pk: "CUSTOMER_PK"
                src_nk: "CUSTOMER_ID"
                src_ldts: "LOADDATE"
                src_source: "SOURCE"
          union:
            materialized: incremental
            schema: vlt
            tags:
              - union
              - hub
            test_hub_parts_current:
              vars:
                source_model:
                  - "test_stg_parts_hashed_current"
                  - "test_stg_supplier_hashed_current"
                  - "test_stg_lineitem_hashed_current"
                src_pk: "PART_PK"
                src_nk: "PART_ID"
                src_ldts: "LOADDATE"
                src_source: "SOURCE"
        load_links:
          hashing: 
            materialized: table
            schema: "stg"
            tags:
              - load_links_hashing
            test_stg_crm_customer_hashed_links_current:
              vars:
                include_source_columns: true
                source_model:
                  test_current: "stg_crm_customer_current"
                hashed_columns:
                  CUSTOMER_PK: CUSTOMER_REF
                  CUSTOMER_FK: CUSTOMER_REF
                  NATION_PK: NATION_KEY
                  NATION_FK: NATION_KEY
                  CUSTOMER_NATION_PK:
                    - CUSTOMER_REF
                    - NATION_KEY            
            test_stg_customer_hashed_links_current:
              vars:
                include_source_columns: true
                source_model:
                  test_current: "stg_customer_links_current"
                hashed_columns:
                  CUSTOMER_PK: CUSTOMER_ID
                  CUSTOMER_FK: CUSTOMER_ID
                  NATION_PK: NATION_ID
                  NATION_FK: NATION_ID
                  CUSTOMER_NATION_PK:
                    - CUSTOMER_ID
                    - NATION_ID
            test_stg_sap_customer_hashed_links_current:
              vars:
                include_source_columns: true
                source_model:
                  test_current: "stg_sap_customer_current"
                hashed_columns:
                  CUSTOMER_PK: CUSTOMER_ID
                  CUSTOMER_FK: CUSTOMER_ID
                  NATION_PK: NATION_ID
                  NATION_FK: NATION_ID
                  CUSTOMER_NATION_PK:
                    - CUSTOMER_ID
                    - NATION_ID
            test_stg_web_customer_hashed_links_current:
              vars:
                include_source_columns: true
                source_model:
                  test_current: "stg_web_customer_current"
                hashed_columns:
                  CUSTOMER_PK: CUSTOMER_REF
                  CUSTOMER_FK: CUSTOMER_REF
                  NATION_PK: NATION_KEY
                  NATION_FK: NATION_KEY
                  CUSTOMER_NATION_PK:
                    - CUSTOMER_REF
                    - NATION_KEY
            test_stg_crm_customer_order_hashed_current:
              vars:
                include_source_columns: true
                source_model:
                  test_current: "stg_crm_customer_order_current"
          single:
            materialized: incremental
            schema: vlt
            tags:
              - single
              - link
            test_link_customer_nation_current:
              vars:
                source_model: "test_stg_crm_customer_hashed_links_current"
                src_pk: "CUSTOMER_NATION_PK"
                src_fk:
                  - "CUSTOMER_FK"
                  - "NATION_FK"
                src_ldts: "LOADDATE"
                src_source: "SOURCE"
            test_link_customer_order_current:
              vars:
                source_model: "test_stg_eff_sat_hashed_current"
                src_pk: "CUSTOMER_ORDER_PK"
                src_fk:
                  - "ORDER_FK"
                  - "CUSTOMER_FK"
                src_ldts: "LOADDATE"
                src_source: "SOURCE"
            test_link_customer_order_multipart_current:
              vars:
                source_model: "test_stg_eff_sat_hashed_current"
                src_pk: "CUSTOMER_ORDER_PK"
                src_fk:
                  - "CUSTOMER_FK"
                  - "NATION_FK"
                  - "ORDER_FK"
                  - "PRODUCT_FK"
                  - "ORGANISATION_FK"
                src_ldts: "LOADDATE"
                src_source: "SOURCE"
          union:
            materialized: incremental
            schema: vlt
            tags:
              - union
              - link
            test_link_customer_nation_union_current:
              vars:
                source_model:
                  - "test_stg_sap_customer_hashed_links_current"
                  - "test_stg_crm_customer_hashed_links_current"
                  - "test_stg_web_customer_hashed_links_current"
                src_pk: "CUSTOMER_NATION_PK"
                src_fk:
                  - "CUSTOMER_FK"
                  - "NATION_FK"
                src_ldts: "LOADDATE"
                src_source: "SOURCE"
            test_link_customer_order_multipart_union_current:
              vars:
                source_model:
                  - "test_stg_eff_sat_hashed_current"
                  - "test_stg_crm_customer_order_hashed_current"
                src_pk: "CUSTOMER_ORDER_PK"
                src_fk:
                  - "CUSTOMER_FK"
                  - "NATION_FK"
                  - "ORDER_FK"
                  - "PRODUCT_FK"
                  - "ORGANISATION_FK"
                src_ldts: "LOADDATE"
                src_source: "SOURCE"
        load_sats:
          hashing:
            materialized: table
            schema: "stg"
            tags:
              - load_sats_hashing
            test_stg_customer_details_hashed_current:
              vars:
                include_source_columns: true
                source_model: 
                  test_current: "stg_customer_details_current"
                hashed_columns:
                  CUSTOMER_PK: CUSTOMER_ID
                  CUSTOMER_HASHDIFF:
                    hashdiff: true
                    columns:
                      - CUSTOMER_ID
                      - CUSTOMER_NAME
                      - CUSTOMER_DOB
                      - CUSTOMER_PHONE
                derived_columns:
                  columns:
                    EFFECTIVE_FROM: LOADDATE
          test_sat_customer_details_current:
            materialized: incremental
            schema: "vlt"
            tags:
              - sat
            vars:
              source_model: "test_stg_customer_details_hashed_current"
              src_pk: "CUSTOMER_PK"
              src_hashdiff: 
                source_column: "CUSTOMER_HASHDIFF"
                alias: "HASHDIFF"
              src_payload:
                - "CUSTOMER_NAME"
                - "CUSTOMER_DOB"
                - "CUSTOMER_PHONE"
              src_eff: "EFFECTIVE_FROM"
              src_ldts: "LOADDATE"
              src_source: "SOURCE"
        load_t_links:
          hashing:
            materialized: table
            schema: "stg"
            tags:
              - load_t_link_hashing
            test_t_link_transaction_hashed_current:
              vars:
                include_source_columns: true
                source_model:
                  test_current: "stg_transaction_current"
                hashed_columns:
                  TRANSACTION_PK: 
                    - CUSTOMER_ID
                    - TRANSACTION_NUMBER
                  CUSTOMER_PK: CUSTOMER_ID
                derived_columns:
                  columns:
                    EFFECTIVE_FROM: TRANSACTION_DATE
          test_t_link_transaction_current:
            materialized: incremental
            schema: "vlt"
            tags:
              - t_link
            vars:
              source_model: "test_t_link_transaction_hashed_current"
              src_pk: "TRANSACTION_PK"
              src_fk: "CUSTOMER_PK"
              src_payload:
                - "TRANSACTION_NUMBER"
                - "TRANSACTION_DATE"
                - "TYPE"
                - "AMOUNT"
              src_eff: "EFFECTIVE_FROM"
              src_ldts: "LOADDATE"
              src_source: "SOURCE"
        load_eff_sats:
          materialized: incremental
          schema: "vlt"
          hashing:
            materialized: table
            schema: "stg"
            tags:
              - load_eff_sat_hashing
            test_stg_eff_sat_hashed_current:
              vars:
                include_source_columns: true
                source_model:
                  test_current: "stg_eff_sat_current"
          test_eff_customer_order_current:
            vars:
              source_model: "test_stg_eff_sat_hashed_current"
              link: "test_link_customer_order_current"
              src_pk: "CUSTOMER_ORDER_PK"
              src_dfk: "CUSTOMER_FK"
              src_sfk: "ORDER_FK"
              src_eff_from: "EFFECTIVE_FROM"
              src_ldts: "LOADDATE"
              src_source: "SOURCE"
          test_eff_customer_order_multipart_current:
            vars:
              source_model: "test_stg_eff_sat_hashed_current"
              link: "test_link_customer_order_multipart_current"
              src_pk: "CUSTOMER_ORDER_PK"
              src_dfk:
                - "CUSTOMER_FK"
                - "NATION_FK"
              src_sfk:
                - "ORDER_FK"
                - "PRODUCT_FK"
                - "ORGANISATION_FK"
              src_eff_from: "EFFECTIVE_FROM"
              src_ldts: "LOADDATE"
              src_source: "SOURCE"
  vars:
    max_date: TO_DATE("9999-12-31")
    
seeds:
  quote_columns: true
  dbtvault_test:
    raw_source:
      column_types:
        CUSTOMER_PK: BINARY(16)
        BOOKING_FK: BINARY(16)
        ORDER_FK: BINARY(16)
        LOADDATE: DATE
    raw_source_2:
      column_types:
        CUSTOMER_PK: BINARY(16)
        BOOKING_FK: BINARY(16)
        ORDER_FK: BINARY(16)
        LOADDATE: DATE
        