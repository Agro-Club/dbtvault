@test_data
@log_cleanup
Feature: Loads Transactional LINKs
# =============================================================================
# CHANGE HISTORY
# ==============
#
# Date     Who Version Details
# -------- --- ------- --------------------------------------------------------
# 09.06.18 NS  1.0     First release.
# 03.01.19 AH  1.1     Modifications of syntax, names and column order.
# =============================================================================

  As the data service manager
  I need to load TRANSACTIONAL LINKs into the vault
  So I can analyse transactional data for downstream analysis

  @log_cleanup
  @clean_data
  Scenario: Empty TRANSACTIONAL LINK loads from staging data
    Given there is an empty vault.TLINK_PARTY_PAYMENT table
    And there are records in the stg.STG_PARTY_PAYMENT table
      | party_payment_hash                   | party_hash  | booking_hash | load_datetime       | source_system | payment_amount | payment_datetime    |
      | md5('1000,B101,2018-01-19 18:35:50') | md5('1000') | md5('B101')  | 2018-01-20 10:00:01 | 1             | 30.45          | 2018-01-19 18:35:50 |
      | md5('1000,B101,2018-01-19 18:37:50') | md5('1000') | md5('B101')  | 2018-01-20 10:00:01 | 1             | 2.10           | 2018-01-19 18:37:50 |
      | md5('1000,B101,2018-01-20 09:10:50') | md5('1000') | md5('B101')  | 2018-01-20 10:00:01 | 1             | -15.00         | 2018-01-20 09:10:50 |
      | md5('1000,B102,2018-01-17 11:40:50') | md5('1000') | md5('B102')  | 2018-01-20 10:00:01 | 1             | 1100.23        | 2018-01-17 11:40:50 |
      | md5('1000,B102,2018-01-17 12:35:50') | md5('1000') | md5('B102')  | 2018-01-20 10:00:01 | 1             | 52.30          | 2018-01-17 12:35:50 |
      | md5('1000,B102,2018-01-18 14:35:50') | md5('1000') | md5('B102')  | 2018-01-20 10:00:01 | 1             | 22.00          | 2018-01-18 14:35:50 |
      | md5('1001,B103,2018-01-19 14:10:50') | md5('1001') | md5('B103')  | 2018-01-20 10:00:01 | 1             | 117.00         | 2018-01-19 14:10:50 |
      | md5('1002,B104,2018-01-19 08:10:50') | md5('1002') | md5('B104')  | 2018-01-20 10:00:01 | 1             | 16.45          | 2018-01-19 08:10:50 |
      | md5('1003,B105,2018-01-19 22:10:50') | md5('1003') | md5('B105')  | 2018-01-20 10:00:01 | 1             | 315.00         | 2018-01-19 22:10:50 |
    And there is no waterlevel record for stg.STG_PARTY_PAYMENT
    And there is metadata mapping stg.STG_PARTY_PAYMENT to vault.TLINK_PARTY_PAYMENT
      | isActive    | true                             |
      | src_table   | stg.STG_PARTY_PAYMENT            |
      | src_pk      | PARTY_PAYMENT_HASH               |
      | src_fk      | PARTY_HASH, BOOKING_HASH         |
      | src_payload | PAYMENT_AMOUNT, PAYMENT_DATETIME |
      | tgt_table   | vault.TLINK_PARTY_PAYMENT        |
      | tgt_pk      | PARTY_PAYMENT_HASH               |
      | tgt_fk      | PARTY_HASH, BOOKING_HASH         |
      | tgt_payload | PAYMENT_AMOUNT, PAYMENT_DATETIME |
    When I run the vaultLoader with command line arguments
    Then the records in STG_PARTY_PAYMENT should have been inserted into vault.TLINK_PARTY_PAYMENT
      | party_payment_hash                   | party_hash  | booking_hash | load_datetime       | source_system | payment_amount | payment_datetime    |
      | md5('1000,B101,2018-01-19 18:35:50') | md5('1000') | md5('B101')  | 2018-01-20 10:00:01 | 1             | 30.45          | 2018-01-19 18:35:50 |
      | md5('1000,B101,2018-01-19 18:37:50') | md5('1000') | md5('B101')  | 2018-01-20 10:00:01 | 1             | 2.10           | 2018-01-19 18:37:50 |
      | md5('1000,B101,2018-01-20 09:10:50') | md5('1000') | md5('B101')  | 2018-01-20 10:00:01 | 1             | -15.00         | 2018-01-20 09:10:50 |
      | md5('1000,B102,2018-01-17 11:40:50') | md5('1000') | md5('B102')  | 2018-01-20 10:00:01 | 1             | 1100.23        | 2018-01-17 11:40:50 |
      | md5('1000,B102,2018-01-17 12:35:50') | md5('1000') | md5('B102')  | 2018-01-20 10:00:01 | 1             | 52.30          | 2018-01-17 12:35:50 |
      | md5('1000,B102,2018-01-18 14:35:50') | md5('1000') | md5('B102')  | 2018-01-20 10:00:01 | 1             | 22.00          | 2018-01-18 14:35:50 |
      | md5('1001,B103,2018-01-19 14:10:50') | md5('1001') | md5('B103')  | 2018-01-20 10:00:01 | 1             | 117.00         | 2018-01-19 14:10:50 |
      | md5('1002,B104,2018-01-19 08:10:50') | md5('1002') | md5('B104')  | 2018-01-20 10:00:01 | 1             | 16.45          | 2018-01-19 08:10:50 |
      | md5('1003,B105,2018-01-19 22:10:50') | md5('1003') | md5('B105')  | 2018-01-20 10:00:01 | 1             | 315.00         | 2018-01-19 22:10:50 |
    And the waterlevel record for "stg.STG_PARTY_PAYMENT" is "2018-01-20 10:00:01"

  @log_cleanup
  @clean_data
  Scenario: Transactional Link duplicate feed is ignored
    Given there are records in the vault.TLINK_PARTY_PAYMENT table
      | party_payment_hash                   | party_hash  | booking_hash | load_datetime       | source_system | payment_amount | payment_datetime    |
      | md5('1000,B101,2018-01-19 18:35:50') | md5('1000') | md5('B101')  | 2018-01-20 10:00:01 | 1             | 30.45          | 2018-01-19 18:35:50 |
      | md5('1000,B101,2018-01-19 18:37:50') | md5('1000') | md5('B101')  | 2018-01-20 10:00:01 | 1             | 2.10           | 2018-01-19 18:37:50 |
      | md5('1000,B101,2018-01-20 09:10:50') | md5('1000') | md5('B101')  | 2018-01-20 10:00:01 | 1             | -15.00         | 2018-01-20 09:10:50 |
      | md5('1000,B102,2018-01-17 11:40:50') | md5('1000') | md5('B102')  | 2018-01-20 10:00:01 | 1             | 1100.23        | 2018-01-17 11:40:50 |
      | md5('1000,B102,2018-01-17 12:35:50') | md5('1000') | md5('B102')  | 2018-01-20 10:00:01 | 1             | 52.30          | 2018-01-17 12:35:50 |
      | md5('1000,B102,2018-01-18 14:35:50') | md5('1000') | md5('B102')  | 2018-01-20 10:00:01 | 1             | 22.00          | 2018-01-18 14:35:50 |
      | md5('1001,B103,2018-01-19 14:10:50') | md5('1001') | md5('B103')  | 2018-01-20 10:00:01 | 1             | 117.00         | 2018-01-19 14:10:50 |
      | md5('1002,B104,2018-01-19 08:10:50') | md5('1002') | md5('B104')  | 2018-01-20 10:00:01 | 1             | 16.45          | 2018-01-19 08:10:50 |
      | md5('1003,B105,2018-01-19 22:10:50') | md5('1003') | md5('B105')  | 2018-01-20 10:00:01 | 1             | 315.00         | 2018-01-19 22:10:50 |
    And the waterlevel record for "stg.STG_PARTY_PAYMENT" is "2018-01-20 10:00:01"
    And there are overlapping records in the stg.STG_PARTY_PAYMENT table
      | party_payment_hash                   | party_hash  | booking_hash | load_datetime       | source_system | payment_amount | payment_datetime    |
      | md5('1000,B101,2018-01-19 18:35:50') | md5('1000') | md5('B101')  | 2018-01-20 10:00:01 | 1             | 30.45          | 2018-01-19 18:35:50 |
      | md5('1000,B101,2018-01-19 18:37:50') | md5('1000') | md5('B101')  | 2018-01-20 10:00:01 | 1             | 2.10           | 2018-01-19 18:37:50 |
      | md5('1000,B101,2018-01-20 09:10:50') | md5('1000') | md5('B101')  | 2018-01-20 10:00:01 | 1             | -15.00         | 2018-01-20 09:10:50 |
      | md5('1000,B102,2018-01-17 11:40:50') | md5('1000') | md5('B102')  | 2018-01-20 10:00:01 | 1             | 1100.23        | 2018-01-17 11:40:50 |
      | md5('1000,B102,2018-01-17 12:35:50') | md5('1000') | md5('B102')  | 2018-01-20 10:00:01 | 1             | 52.30          | 2018-01-17 12:35:50 |
      | md5('1000,B102,2018-01-18 14:35:50') | md5('1000') | md5('B102')  | 2018-01-20 10:00:01 | 1             | 22.00          | 2018-01-18 14:35:50 |
      | md5('1001,B103,2018-01-19 14:10:50') | md5('1001') | md5('B103')  | 2018-01-20 10:00:01 | 1             | 117.00         | 2018-01-19 14:10:50 |
      | md5('1002,B104,2018-01-19 08:10:50') | md5('1002') | md5('B104')  | 2018-01-20 10:00:01 | 1             | 16.45          | 2018-01-19 08:10:50 |
      | md5('1003,B105,2018-01-19 22:10:50') | md5('1003') | md5('B105')  | 2018-01-20 10:00:01 | 1             | 315.00         | 2018-01-19 22:10:50 |
    And there is metadata mapping stg.STG_PARTY_PAYMENT to vault.TLINK_PARTY_PAYMENT
      | isActive    | true                             |
      | src_table   | stg.STG_PARTY_PAYMENT            |
      | src_pk      | PARTY_PAYMENT_HASH               |
      | src_fk      | PARTY_HASH, BOOKING_HASH         |
      | src_payload | PAYMENT_AMOUNT, PAYMENT_DATETIME |
      | tgt_table   | vault.TLINK_PARTY_PAYMENT        |
      | tgt_pk      | PARTY_PAYMENT_HASH               |
      | tgt_fk      | PARTY_HASH, BOOKING_HASH         |
      | tgt_payload | PAYMENT_AMOUNT, PAYMENT_DATETIME |
    When I run the vaultLoader with command line arguments
    Then there should be no change to the records in vault.TLINK_PARTY_PAYMENT table
      | party_payment_hash                   | party_hash  | booking_hash | load_datetime       | source_system | payment_amount | payment_datetime    |
      | md5('1000,B101,2018-01-19 18:35:50') | md5('1000') | md5('B101')  | 2018-01-20 10:00:01 | 1             | 30.45          | 2018-01-19 18:35:50 |
      | md5('1000,B101,2018-01-19 18:37:50') | md5('1000') | md5('B101')  | 2018-01-20 10:00:01 | 1             | 2.10           | 2018-01-19 18:37:50 |
      | md5('1000,B101,2018-01-20 09:10:50') | md5('1000') | md5('B101')  | 2018-01-20 10:00:01 | 1             | -15.00         | 2018-01-20 09:10:50 |
      | md5('1000,B102,2018-01-17 11:40:50') | md5('1000') | md5('B102')  | 2018-01-20 10:00:01 | 1             | 1100.23        | 2018-01-17 11:40:50 |
      | md5('1000,B102,2018-01-17 12:35:50') | md5('1000') | md5('B102')  | 2018-01-20 10:00:01 | 1             | 52.30          | 2018-01-17 12:35:50 |
      | md5('1000,B102,2018-01-18 14:35:50') | md5('1000') | md5('B102')  | 2018-01-20 10:00:01 | 1             | 22.00          | 2018-01-18 14:35:50 |
      | md5('1001,B103,2018-01-19 14:10:50') | md5('1001') | md5('B103')  | 2018-01-20 10:00:01 | 1             | 117.00         | 2018-01-19 14:10:50 |
      | md5('1002,B104,2018-01-19 08:10:50') | md5('1002') | md5('B104')  | 2018-01-20 10:00:01 | 1             | 16.45          | 2018-01-19 08:10:50 |
      | md5('1003,B105,2018-01-19 22:10:50') | md5('1003') | md5('B105')  | 2018-01-20 10:00:01 | 1             | 315.00         | 2018-01-19 22:10:50 |
    And the waterlevel record for "stg.STG_PARTY_PAYMENT" is "2018-01-20 10:00:01"

  @log_cleanup
  @clean_data
  Scenario: Add records to Transactional Link
    Given there are records in the vault.TLINK_PARTY_PAYMENT table
      | party_payment_hash                   | party_hash  | booking_hash | load_datetime       | source_system | payment_amount | payment_datetime    |
      | md5('1000,B101,2018-01-19 18:35:50') | md5('1000') | md5('B101')  | 2018-01-20 10:00:01 | 1             | 30.45          | 2018-01-19 18:35:50 |
      | md5('1000,B101,2018-01-19 18:37:50') | md5('1000') | md5('B101')  | 2018-01-20 10:00:01 | 1             | 2.10           | 2018-01-19 18:37:50 |
      | md5('1000,B101,2018-01-20 09:10:50') | md5('1000') | md5('B101')  | 2018-01-20 10:00:01 | 1             | -15.00         | 2018-01-20 09:10:50 |
      | md5('1000,B102,2018-01-17 11:40:50') | md5('1000') | md5('B102')  | 2018-01-20 10:00:01 | 1             | 1100.23        | 2018-01-17 11:40:50 |
      | md5('1000,B102,2018-01-17 12:35:50') | md5('1000') | md5('B102')  | 2018-01-20 10:00:01 | 1             | 52.30          | 2018-01-17 12:35:50 |
      | md5('1000,B102,2018-01-18 14:35:50') | md5('1000') | md5('B102')  | 2018-01-20 10:00:01 | 1             | 22.00          | 2018-01-18 14:35:50 |
      | md5('1001,B103,2018-01-19 14:10:50') | md5('1001') | md5('B103')  | 2018-01-20 10:00:01 | 1             | 117.00         | 2018-01-19 14:10:50 |
      | md5('1002,B104,2018-01-19 08:10:50') | md5('1002') | md5('B104')  | 2018-01-20 10:00:01 | 1             | 16.45          | 2018-01-19 08:10:50 |
      | md5('1003,B105,2018-01-19 22:10:50') | md5('1003') | md5('B105')  | 2018-01-20 10:00:01 | 1             | 315.00         | 2018-01-19 22:10:50 |
    And the waterlevel record for "stg.STG_PARTY_PAYMENT" is "2018-01-20 10:00:01"
    And there are records in the stg.STG_PARTY_PAYMENT table
      | party_payment_hash                   | party_hash  | booking_hash | load_datetime       | source_system | payment_amount | payment_datetime    |
      | md5('1000,B101,2018-01-21 18:35:50') | md5('1000') | md5('B101')  | 2018-01-22 10:00:01 | 1             | 30.45          | 2018-01-21 18:35:50 |
      | md5('1000,B101,2018-01-21 18:37:50') | md5('1000') | md5('B101')  | 2018-01-22 10:00:01 | 1             | 2.10           | 2018-01-21 18:37:50 |
      | md5('1000,B101,2018-01-22 09:10:50') | md5('1000') | md5('B101')  | 2018-01-22 10:00:01 | 1             | -15.00         | 2018-01-22 09:10:50 |
      | md5('1000,B102,2018-01-21 11:40:50') | md5('1000') | md5('B102')  | 2018-01-22 10:00:01 | 1             | 1100.23        | 2018-01-21 11:40:50 |
      | md5('1000,B102,2018-01-21 12:35:50') | md5('1000') | md5('B102')  | 2018-01-22 10:00:01 | 1             | 52.30          | 2018-01-21 12:35:50 |
      | md5('1000,B102,2018-01-21 14:35:50') | md5('1000') | md5('B102')  | 2018-01-22 10:00:01 | 1             | 22.00          | 2018-01-21 14:35:50 |
      | md5('1001,B103,2018-01-21 14:10:50') | md5('1001') | md5('B103')  | 2018-01-22 10:00:01 | 1             | 117.00         | 2018-01-21 14:10:50 |
      | md5('1002,B104,2018-01-21 08:10:50') | md5('1002') | md5('B104')  | 2018-01-22 10:00:01 | 1             | 16.45          | 2018-01-21 08:10:50 |
      | md5('1003,B105,2018-01-21 22:10:50') | md5('1003') | md5('B105')  | 2018-01-22 10:00:01 | 1             | 315.00         | 2018-01-21 22:10:50 |
    And there is metadata mapping stg.STG_PARTY_PAYMENT to vault.TLINK_PARTY_PAYMENT
      | isActive    | true                             |
      | src_table   | stg.STG_PARTY_PAYMENT            |
      | src_pk      | PARTY_PAYMENT_HASH               |
      | src_fk      | PARTY_HASH, BOOKING_HASH         |
      | src_payload | PAYMENT_AMOUNT, PAYMENT_DATETIME |
      | tgt_table   | vault.TLINK_PARTY_PAYMENT        |
      | tgt_pk      | PARTY_PAYMENT_HASH               |
      | tgt_fk      | PARTY_HASH, BOOKING_HASH         |
      | tgt_payload | PAYMENT_AMOUNT, PAYMENT_DATETIME |
    When I run the vaultLoader with command line arguments
    Then records should be added to the records in vault.TLINK_PARTY_PAYMENT table
      | party_payment_hash                   | party_hash  | booking_hash | load_datetime       | source_system | payment_amount | payment_datetime    |
      | md5('1000,B101,2018-01-19 18:35:50') | md5('1000') | md5('B101')  | 2018-01-20 10:00:01 | 1             | 30.45          | 2018-01-19 18:35:50 |
      | md5('1000,B101,2018-01-19 18:37:50') | md5('1000') | md5('B101')  | 2018-01-20 10:00:01 | 1             | 2.10           | 2018-01-19 18:37:50 |
      | md5('1000,B101,2018-01-20 09:10:50') | md5('1000') | md5('B101')  | 2018-01-20 10:00:01 | 1             | -15.00         | 2018-01-20 09:10:50 |
      | md5('1000,B102,2018-01-17 11:40:50') | md5('1000') | md5('B102')  | 2018-01-20 10:00:01 | 1             | 1100.23        | 2018-01-17 11:40:50 |
      | md5('1000,B102,2018-01-17 12:35:50') | md5('1000') | md5('B102')  | 2018-01-20 10:00:01 | 1             | 52.30          | 2018-01-17 12:35:50 |
      | md5('1000,B102,2018-01-18 14:35:50') | md5('1000') | md5('B102')  | 2018-01-20 10:00:01 | 1             | 22.00          | 2018-01-18 14:35:50 |
      | md5('1001,B103,2018-01-19 14:10:50') | md5('1001') | md5('B103')  | 2018-01-20 10:00:01 | 1             | 117.00         | 2018-01-19 14:10:50 |
      | md5('1002,B104,2018-01-19 08:10:50') | md5('1002') | md5('B104')  | 2018-01-20 10:00:01 | 1             | 16.45          | 2018-01-19 08:10:50 |
      | md5('1003,B105,2018-01-19 22:10:50') | md5('1003') | md5('B105')  | 2018-01-20 10:00:01 | 1             | 315.00         | 2018-01-19 22:10:50 |
      | md5('1000,B101,2018-01-21 18:35:50') | md5('1000') | md5('B101')  | 2018-01-22 10:00:01 | 1             | 30.45          | 2018-01-21 18:35:50 |
      | md5('1000,B101,2018-01-21 18:37:50') | md5('1000') | md5('B101')  | 2018-01-22 10:00:01 | 1             | 2.10           | 2018-01-21 18:37:50 |
      | md5('1000,B101,2018-01-22 09:10:50') | md5('1000') | md5('B101')  | 2018-01-22 10:00:01 | 1             | -15.00         | 2018-01-22 09:10:50 |
      | md5('1000,B102,2018-01-21 11:40:50') | md5('1000') | md5('B102')  | 2018-01-22 10:00:01 | 1             | 1100.23        | 2018-01-21 11:40:50 |
      | md5('1000,B102,2018-01-21 12:35:50') | md5('1000') | md5('B102')  | 2018-01-22 10:00:01 | 1             | 52.30          | 2018-01-21 12:35:50 |
      | md5('1000,B102,2018-01-21 14:35:50') | md5('1000') | md5('B102')  | 2018-01-22 10:00:01 | 1             | 22.00          | 2018-01-21 14:35:50 |
      | md5('1001,B103,2018-01-21 14:10:50') | md5('1001') | md5('B103')  | 2018-01-22 10:00:01 | 1             | 117.00         | 2018-01-21 14:10:50 |
      | md5('1002,B104,2018-01-21 08:10:50') | md5('1002') | md5('B104')  | 2018-01-22 10:00:01 | 1             | 16.45          | 2018-01-21 08:10:50 |
      | md5('1003,B105,2018-01-21 22:10:50') | md5('1003') | md5('B105')  | 2018-01-22 10:00:01 | 1             | 315.00         | 2018-01-21 22:10:50 |
    And the waterlevel record for "stg.STG_PARTY_PAYMENT" is "2018-01-22 10:00:01"


